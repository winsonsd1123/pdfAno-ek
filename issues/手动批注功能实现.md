# 手动批注功能实现记录

## 任务概述
为 PDF 阅读工具添加手动批注功能，用户可以通过十字光标在 PDF 上绘制标注框，自动提取框内文字并创建批注。

## 实现方案
选择覆盖式 Canvas 绘制方案，复用现有 div 渲染逻辑。

## 已完成功能

### 1. 上下文状态管理扩展 ✓
- **文件**: `contexts/PdfAnoContext.tsx`
- **新增状态**: `isManualAnnotationMode` - 手动批注模式开关
- **新增方法**: 
  - `toggleManualAnnotationMode()` - 切换手动批注模式
  - `extractTextFromRect()` - 从矩形区域提取文本
  - `addManualAnnotation()` - 创建手动批注

### 2. 工具栏按钮 ✓
- **文件**: `components/pdf-ano/PdfToolbar.tsx`
- **位置**: AI自动批注按钮左侧
- **功能**: 点击切换手动批注模式，按钮状态会高亮显示
- **图标**: Pencil (铅笔)

### 3. 绘制层系统 ✓
- **文件**: `components/pdf-ano/PdfViewer.tsx`
- **实现**: 为每个 PDF 页面添加透明覆盖 canvas
- **功能**: 
  - 实时绘制虚线矩形选框
  - 十字光标样式
  - 自动尺寸同步
  - zIndex 层次管理

### 4. 鼠标交互 ✓
- **mousedown**: 记录起始坐标，开始绘制
- **mousemove**: 实时更新选框，显示预览
- **mouseup**: 完成绘制，触发文本提取和批注创建
- **mouseleave**: 取消当前绘制操作

### 5. 文本提取算法 ✓
- **坐标转换**: 屏幕坐标 → PDF坐标
- **重叠检测**: 文本块与选择矩形的几何重叠判断
- **文本排序**: 按位置从上到下、从左到右排序
- **内容拼接**: 保持原有文本结构

### 6. 批注数据创建 ✓
- **格式**: 符合现有 Annotation 类型规范
- **坐标**: 使用标准化的坐标信息结构
- **作者**: 自动添加默认作者信息
- **渲染**: 自动被 PdfViewer 的现有逻辑渲染显示

### 7. 用户体验优化 ✓
- **键盘支持**: ESC 键取消当前绘制
- **防误触**: 最小选择区域限制 (10×10像素)
- **视觉反馈**: 虚线边框 + 半透明填充
- **交互限制**: 
  - 禁用右键菜单
  - 手动模式下禁用文字选择
  - 只在手动模式下响应绘制事件

## 技术细节

### 坐标系统
- **Screen** → **Canvas** → **Viewport** → **PDF**
- 处理不同 scale 级别的坐标转换
- 考虑 PDF 坐标系（左下角原点）与浏览器坐标系（左上角原点）的差异

### 性能优化
- 使用 useCallback 防止不必要的重渲染
- canvas 绘制避免了 React 状态更新带来的性能问题
- 合理的事件处理和清理逻辑

### 错误处理
- PDF 文档未加载时的保护
- 文本提取失败的容错
- 网络异常的处理

## 使用方法
1. 点击工具栏"手动批注"按钮激活模式
2. 鼠标光标变为十字星
3. 在 PDF 页面上拖拽绘制矩形选框
4. 松开鼠标，系统自动提取框内文字并创建批注
5. 再次点击"手动批注"按钮可退出模式
6. 按 ESC 键可取消当前绘制操作

## 实现时间
2024-12-27 完成

### 8. 显示效果优化 ✓
- **问题**: 手动批注在右侧面板显示效果与 AI 批注不一致
- **解决**: 为手动批注添加 `aiAnnotation` 结构
- **效果**: 手动批注现在显示引用文本框和结构化内容，与 AI 批注视觉效果一致

## 状态
✅ 完成实现
✅ 显示效果已优化
🔧 等待完整测试验证 