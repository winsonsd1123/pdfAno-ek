# 用户认证与权限管理系统实施方案

本方案旨在为 pdfAno-ek 项目添加一套完整的、基于 Supabase 的用户认证和角色权限管理系统。

## 核心架构

采用 **混合后端 API 模式**，将核心业务逻辑和权限校验封装在 Next.js 的 API 路由中，以确保系统的灵活性和未来的可迁移性。

---

## 详细执行计划

### 第一阶段：地基搭建 (Supabase & 环境配置)

| 步骤 | 操作 | 预期结果 | 状态 |
| :--- | :--- | :--- | :--- |
| 1.1 | **安装依赖**: `pnpm add @supabase/supabase-js @supabase/ssr` | 核心库安装成功 | ☑️ |
| 1.2 | **创建数据库表**: 在 Supabase后台执行 SQL 脚本，创建`roles`, `profiles`, `permissions`, `role_permissions`表 | 数据库表结构和初始数据创建完毕 | ☑️ |
| 1.3 | **配置环境变量**: 在 `.env.local` 中添加 Supabase URL 和密钥 | 应用能成功连接到 Supabase 服务 | ☑️ |
| 1.4 | **启用RLS**: 为关键表启用行级安全策略，作为基础安全保障 | 数据表获得基础的访问控制策略 | ☑️ |

### 第二阶段：架构核心 (类型、中间件与 API)

| 步骤 | 操作 | 预期结果 | 状态 |
| :--- | :--- | :--- | :--- |
| 2.1 | **定义 TypeScript 类型**: 在 `types/supabase.ts` 中创建与数据库表对应的类型定义 | 项目拥有统一、强类型的数据模型 | ☑️ |
| 2.2 | **创建 Next.js 中间件**: 创建 `middleware.ts` 用于路由守卫，保护 `/admin` 和 `/pdfano` 等核心路由 | 未授权的访问被有效拦截或重定向 | ☑️ |
| 2.3 | **开发后端管理 API**: 创建 `/api/admin/**` 系列接口，用于管理用户、角色和权限，并内置管理员权限校验 | 提供一套安全的、仅限管理员使用的后端管理接口 | ☑️ |

### 第三阶段：用户界面 (UI & 交互)

| 步骤 | 操作 | 预期结果 | 状态 |
| :--- | :--- | :--- | :--- |
| 3.1 | **创建全局用户状态管理器**: 创建 `contexts/UserContext.tsx`，在 `app/layout.tsx` 中使用 | 所有组件都能方便地获取和响应用户登录状态 | ☐ |
| 3.2 | **创建登录/注册页面**: 创建 `app/login/page.tsx` 和 `app/signup/page.tsx` | 用户能通过 UI 完成注册和登录 | ☐ |
| 3.3 | **创建后台管理界面**: 创建 `/admin/**` 路由下的布局和页面，实现用户和角色的可视化管理 | 管理员拥有一个功能完整的后台管理界面 | ☐ | 